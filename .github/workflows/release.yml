name: Build & Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Build Firefox extension (zip)
        run: |
          mkdir -p dist
          zip -r "dist/humble-steam-check-${{ steps.version.outputs.version }}-firefox.zip" \
            manifest.json background.js content.js matcher.js \
            popup.html popup.js styles.css icons/ \
            LICENSE README.md

      - name: Build Chrome extension (zip)
        run: |
          # Chrome doesn't support browser_specific_settings or background.scripts in MV3
          mkdir -p chrome-build
          cp -r manifest.json background.js content.js matcher.js \
            popup.html popup.js styles.css icons/ LICENSE README.md chrome-build/

          # Convert manifest for Chrome
          cd chrome-build
          python3 -c "
          import json
          with open('manifest.json') as f:
              m = json.load(f)
          # Remove Firefox-specific settings
          m.pop('browser_specific_settings', None)
          # Chrome MV3 uses service_worker instead of scripts
          m['background'] = {'service_worker': 'background.js', 'type': 'module'}
          with open('manifest.json', 'w') as f:
              json.dump(m, f, indent=2)
          "
          cd ..

          # Replace browser.* with chrome.* for Chrome compatibility
          cd chrome-build
          sed -i 's/browser\.runtime/chrome.runtime/g; s/browser\.storage/chrome.storage/g' \
            background.js content.js popup.js
          cd ..

          zip -r "dist/humble-steam-check-${{ steps.version.outputs.version }}-chrome.zip" \
            -j chrome-build/*
          # Re-add icons directory structure
          cd chrome-build && zip -r "../dist/humble-steam-check-${{ steps.version.outputs.version }}-chrome.zip" icons/
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Humble Steam Check v${{ steps.version.outputs.version }}"
          body: |
            ## Installation

            ### Firefox
            1. Download `humble-steam-check-${{ steps.version.outputs.version }}-firefox.zip`
            2. Open `about:debugging#/runtime/this-firefox`
            3. Click "Load Temporary Add-on" and select the zip file

            ### Chrome
            1. Download `humble-steam-check-${{ steps.version.outputs.version }}-chrome.zip`
            2. Unzip it
            3. Open `chrome://extensions`, enable Developer Mode
            4. Click "Load unpacked" and select the unzipped folder

            See [README](https://github.com/${{ github.repository }}#setup) for setup instructions.
          files: |
            dist/humble-steam-check-${{ steps.version.outputs.version }}-firefox.zip
            dist/humble-steam-check-${{ steps.version.outputs.version }}-chrome.zip
          draft: false
          prerelease: false
